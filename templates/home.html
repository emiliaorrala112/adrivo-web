{% extends 'base.html' %}
{% load static %}

{% block content %}

<style>
    /* HERO */
    .wow-hero { background: linear-gradient(-45deg, #ff4b9a, #ba68c8, #ffd54f, #ff9a9e); background-size: 400% 400%; animation: gradientBG 10s ease infinite; min-height: 240px; display: flex; flex-direction: column; justify-content: center; align-items: center; text-align: center; color: white; margin-bottom: 40px; border-radius: 0 0 50px 50px; box-shadow: 0 10px 30px rgba(232, 62, 140, 0.2); }
    @keyframes gradientBG { 0% { background-position: 0% 50%; } 50% { background-position: 100% 50%; } 100% { background-position: 0% 50%; } }
    .hero-content h1 { font-family: 'Pacifico', cursive; font-size: 3.5rem; margin: 0; text-shadow: 0 4px 15px rgba(0,0,0,0.1); }
    
    /* Estilos para los íconos de fondo (Bolsa y Perfume) */
    .hero-icon {
        position: absolute;
        font-size: 10rem; /* Tamaño grande */
        color: rgba(255, 255, 255, 0.25); /* Blanco transparente para que se mezcle */
        z-index: 0; /* Para que quede DETRÁS del texto */
        pointer-events: none; /* Para que no estorbe al click */
    }
    
    /* Posición del Perfume (Izquierda) */
    .icon-left {
        left: 5%;
        top: 50%;
        transform: translateY(-50%) rotate(-15deg);
    }

    /* Posición de la Bolsa (Derecha) */
    .icon-right {
        right: 5%;
        top: 50%;
        transform: translateY(-50%) rotate(15deg);
    }

    /* Ocultar en celulares para que no tape el texto */
    @media (max-width: 768px) { 
        .hero-icon { display: none; } 
    }

    /* Asegurar que el texto esté encima de los íconos */
    .hero-content {
        position: relative;
        z-index: 2; 
    }

    /* SLIDER */
    .slider-section { width: 100%; max-width: 1600px; margin: 0 auto 50px; position: relative; padding: 0 40px; }
    .slider-title { text-align: center; color: #ba68c8; font-family: 'Pacifico', cursive; font-size: 2rem; margin-bottom: 20px; }
    .slider-container { display: flex; overflow-x: auto; gap: 20px; padding: 20px 5px; scrollbar-width: none; }
    .slider-container::-webkit-scrollbar { display: none; }
    .slider-btn { position: absolute; top: 55%; transform: translateY(-50%); width: 45px; height: 45px; border-radius: 50%; background: white; border: none; box-shadow: 0 4px 10px rgba(0,0,0,0.1); color: #ff4b9a; cursor: pointer; z-index: 10; font-size: 1.2rem; transition: 0.3s; }
    .slider-btn:hover { background: #ff4b9a; color: white; }
    .prev-btn { left: 0; } .next-btn { right: 0; }

    /* LAYOUT Y SIDEBAR */
    .catalog-wrapper { display: grid; grid-template-columns: 280px 1fr; gap: 40px; max-width: 1600px; margin: 0 auto 60px; padding: 0 20px; width: 100%; }
    .results-header { text-align: center; margin: 30px 0; }

    .filter-sidebar { background: white; padding: 25px; border-radius: 20px; box-shadow: 0 5px 20px rgba(232, 62, 140, 0.08); border: 1px solid #fff0f6; height: fit-content; }
    .filter-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px; border-bottom: 2px solid #fff0f6; padding-bottom: 10px; }
    .filter-title { font-weight: 800; font-size: 1.1rem; color: #333; display: flex; align-items: center; gap: 8px; }
    
    details.filter-group { margin-bottom: 15px; border-bottom: 1px dashed #eee; padding-bottom: 15px; }
    summary { font-weight: 700; color: #555; cursor: pointer; display: flex; justify-content: space-between; list-style: none; transition: 0.3s; }
    summary:hover { color: #ff4b9a; }
    summary::after { content: '+'; font-weight: 900; color: #ff4b9a; }
    details[open] summary::after { content: '-'; }

    .checkbox-item { margin-bottom: 8px; font-size: 0.95rem; color: #666; display: flex; align-items: center; cursor: pointer; transition: 0.2s; }
    .checkbox-item:hover { color: #ff4b9a; transform: translateX(5px); }
    .checkbox-item input { accent-color: #ff4b9a; margin-right: 10px; width: 18px; height: 18px; cursor: pointer; }

    /* PRECIO */
    .price-row { display: flex; gap: 10px; align-items: center; justify-content: center; margin-bottom: 10px; }
    .price-input { width: 80px; padding: 8px; border: 1px solid #ddd; border-radius: 10px; text-align: center; font-weight: bold; color: #555; background: #fafafa; }
    .btn-apply { background: #333; color: white; width: 100%; padding: 10px; border-radius: 50px; border: none; cursor: pointer; font-weight: 700; transition: 0.3s; }
    .btn-apply:hover { background: #ff4b9a; box-shadow: 0 4px 10px rgba(232, 62, 140, 0.3); }

    /* PRODUCTOS Y BOTONES */
    .products-grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(220px, 1fr)); gap: 25px; width: 100%; }
    
    .product-card { background: white; border-radius: 20px; overflow: hidden; border: 1px solid #ffeaf2; transition: 0.3s; display: flex; flex-direction: column; position: relative; box-shadow: 0 5px 15px rgba(0,0,0,0.03); height: 100%; }
    .product-card:hover { transform: translateY(-8px); box-shadow: 0 15px 35px rgba(232, 62, 140, 0.15); border-color: #ff4b9a; }
    
    .btn-fav-card { position: absolute; top: 15px; right: 15px; z-index: 10; background: white; width: 35px; height: 35px; border-radius: 50%; display: flex; align-items: center; justify-content: center; border: none; color: #ccc; cursor: pointer; box-shadow: 0 3px 10px rgba(0,0,0,0.1); transition: 0.3s; font-size: 1.2rem; }
    .btn-fav-card:hover { transform: scale(1.1); }
    .btn-fav-card.active { color: #ffc107; }

    .product-img { width: 100%; height: 240px; object-fit: cover; border-bottom: 2px solid #fff0f6; }
    .no-img { width: 100%; height: 240px; background: #fff0f6; display: flex; align-items: center; justify-content: center; color: #ffb7b2; }
    
    .product-info { padding: 15px; text-align: center; display: flex; flex-direction: column; flex-grow: 1; }
    .product-title { font-weight: 700; font-size: 1.05rem; color: #333; margin-bottom: 5px; text-decoration: none; line-height: 1.3; height: 45px; overflow: hidden; display: -webkit-box; -webkit-line-clamp: 2; -webkit-box-orient: vertical; }
    .product-price { color: #ff4b9a; font-weight: 800; font-size: 1.3rem; margin: 5px 0 15px; }
    
    .card-actions { margin-top: auto; display: flex; flex-direction: column; gap: 8px; }
    .btn-card-details { background: white; border: 2px solid #ff4b9a; color: #ff4b9a; padding: 8px; width: 100%; border-radius: 50px; font-weight: 700; cursor: pointer; text-decoration: none; display: block; font-size: 0.85rem; transition: 0.3s; }
    .btn-card-details:hover { background: #fff0f6; }
    
    .btn-card-add { background: linear-gradient(45deg, #ff4b9a, #ba68c8); color: white; border: none; padding: 10px; width: 100%; border-radius: 50px; font-weight: 700; cursor: pointer; text-decoration: none; display: block; font-size: 0.9rem; box-shadow: 0 4px 10px rgba(232, 62, 140, 0.3); transition: 0.3s; }
    .btn-card-add:hover { opacity: 0.95; color: white; transform: translateY(-2px); box-shadow: 0 6px 15px rgba(232, 62, 140, 0.5); }
    
    .btn-card-login { background: #eee; color: #666; border: none; padding: 10px; width: 100%; border-radius: 50px; font-weight: 600; cursor: pointer; text-decoration: none; display: block; font-size: 0.8rem; }
/* --- ESTILO MINIMALISTA MEJORADO (CON BRILLO) --- */
.card-minimal {
    background: white;
    border-radius: 15px;
    border: 1px solid #f0f0f0;
    overflow: hidden;
    position: relative;
    transition: all 0.4s ease; /* Transición suave */
    display: flex;
    flex-direction: column;
    height: 100%;
}

/* EFECTO DE BRILLO AL PASAR EL MOUSE */
.card-minimal:hover {
    transform: translateY(-8px); /* Se levanta más */
    box-shadow: 0 15px 30px rgba(186, 104, 200, 0.25); /* Sombra morada brillante */
    border-color: #ff4b9a; /* Borde rosado sutil */
}

/* Botón Negro -> Cambia a Morado al pasar el mouse */
.btn-black-minimal {
    display: block;
    width: 100%;
    padding: 10px;
    background: #333; 
    color: white;
    text-decoration: none;
    border-radius: 8px;
    font-weight: 600;
    font-size: 0.9rem;
    border: none;
    cursor: pointer;
    transition: 0.3s;
    text-align: center;
    margin-top: 5px;
}

.btn-black-minimal:hover {
    background: #ba68c8; /* CAMBIO DE COLOR (Morado) */
    color: white;
    transform: scale(1.02); /* Crece un poquito */
}

/* Botón Borde -> Se rellena al pasar el mouse */
.btn-outline-minimal {
    display: block;
    width: 100%;
    padding: 8px;
    background: transparent;
    color: #333;
    border: 1px solid #ddd;
    border-radius: 8px;
    font-size: 0.85rem;
    text-align: center;
    text-decoration: none;
    transition: 0.3s;
}

.btn-outline-minimal:hover {
    border-color: #ff4b9a;
    background: #fff0f6;
    color: #ff4b9a;
}

/* =======================================================
   SOLUCIÓN FINAL: LOGO Y CARRITO FIJOS + SCROLL TOTAL
   ======================================================= */
@media (max-width: 900px) {

    /* 1. ROMPEMOS EL CANDADO DE JAZZMIN (IMPORTANTE) */
    /* Esto obliga a la caja gris del menú a moverse cuando bajas */
    body.layout-navbar-fixed .wrapper .main-header,
    .main-header,
    .navbar {
        position: absolute !important; /* Cambiamos fixed por absolute */
        top: 0 !important;
        width: 100% !important;
        background: transparent !important; /* Fondo transparente para no tapar */
        border: none !important;
    }

    /* 2. BARRA BLANCA SUPERIOR (SOLO PARA LOGO Y NOMBRE) */
    /* Esta es la única parte que se queda fija pegada al techo */
    .brand-badge {
        position: fixed !important; 
        top: 0 !important;
        left: 0 !important;
        width: 100% !important;
        height: 60px !important;    
        
        background: white !important; /* Fondo blanco */
        display: flex !important;
        justify-content: center !important; /* Centrado */
        align-items: center !important;
        
        z-index: 9999 !important;   /* Encima de todo */
        box-shadow: 0 2px 10px rgba(0,0,0,0.05) !important;
        border-bottom: 1px solid #f0f0f0 !important;
    }

    .brand-badge img { width: 35px !important; height: 35px !important; }
    
    .brand-badge span { 
        display: block !important;
        font-size: 1.4rem !important; 
        font-weight: 800 !important;
        color: #ff4b9a !important; 
        margin-left: 8px !important;
        font-family: 'Pacifico', cursive, sans-serif !important;
    }

    /* 3. EL CARRITO -> EN LA ESQUINA SUPERIOR DERECHA (FIJO) */
    a[title="Ver Carrito"] {
        position: fixed !important; /* Se queda pegado */
        top: 12px !important;       /* Centrado verticalmente en la barra de 60px */
        right: 15px !important;     /* Pegado a la derecha */
        z-index: 10000 !important;  /* Encima del logo incluso */
        
        background: #ff4b9a !important; 
        width: 36px !important; height: 36px !important;
        border-radius: 50% !important;
        display: flex !important;
        justify-content: center !important;
        align-items: center !important;
        box-shadow: 0 3px 8px rgba(255, 75, 154, 0.4) !important;
    }
    a[title="Ver Carrito"] i { color: white !important; font-size: 1rem !important; margin: 0 !important; }
    .count-pill { top: -2px !important; right: -2px !important; }


    /* 4. LO QUE SE DEBE ESCONDER (BUSCADOR E ICONOS) */
    /* Esta parte ahora es móvil y subirá cuando bajes la pantalla */
    .header-top {
        display: flex !important;
        flex-direction: column !important;
        align-items: center !important;
        background: white !important; /* Fondo blanco para tapar contenido al subir */
        
        /* ¡MUY IMPORTANTE! */
        /* Empujamos esto 65px hacia abajo para que empiece DEBAJO de la barra fija */
        padding-top: 70px !important; 
        padding-bottom: 10px !important;
        
        /* Aseguramos que ocupe el ancho */
        width: 100% !important;
    }

    /* A. BUSCADOR (Se mueve y desaparece al bajar) */
    .search-form {
        width: 95% !important;
        margin-bottom: 15px !important;
        order: 1; 
    }

    /* B. ICONOS DE ACCIÓN (Nosotros, Config, etc. - Se mueven y desaparecen) */
    .header-actions {
        width: 100% !important;
        display: flex !important;
        justify-content: center !important;
        gap: 25px !important; 
        margin-bottom: 5px !important;
        order: 2;
    }
    
    /* Limpieza visual */
    .header-actions span { display: none !important; } 
    .header-actions a[title="Sobre Nosotros"] span { display: none !important; }
    .header-actions i, .icon-btn { font-size: 1.4rem !important; color: #555 !important; }

    /* --- EXTRAS --- */
    /* Ajustamos el margen del hero para que no choque */
    .wow-hero { margin-top: 0 !important; min-height: 100px !important; padding: 10px !important; }
    .hero-content h1 { font-size: 1.5rem !important; }
    .hero-icon { display: none !important; }
    
    .catalog-wrapper { display: block !important; padding: 0 5px !important; }
    .filter-sidebar { display: none; }
    .products-grid { grid-template-columns: repeat(2, 1fr) !important; gap: 8px !important; }
}
</style>


{% if not query and not cats_selected and not tipos_selected and not marcas_selected %}
<section class="wow-hero" style="position: relative; overflow: hidden;">
    
    <i class="fas fa-pump-soap hero-icon icon-left"></i>
    
    <i class="fas fa-shopping-bag hero-icon icon-right"></i>

    <div class="hero-content">
        <h1>Tu estilo, tu universo.</h1>
        <p style="font-size: 1.2rem; opacity: 0.9;">Lo mejor en belleza a precios increíbles.</p>
    </div>
</section>

   <section class="novedades-section" style="margin-top: 0px; padding-top: 20px; padding-bottom: 50px; background-color: #fff0f6;">
    <div class="container" style="max-width: 1400px; margin: 0 auto; position: relative; padding: 0 20px;">
        
        <h3 style="text-align: center; margin-bottom: 40px; color: #6b686c; font-family: 'Poppins', sans-serif; font-weight: 800; font-size: 2.2rem; text-transform: uppercase; letter-spacing: 1px; text-shadow: 2px 2px 0px white;">
            Últimas Novedades 
        </h3>

        <div class="swiper mySwiper" style="padding: 20px 10px;">
            <div class="swiper-wrapper">
                
                {% for p in productos|slice:":13" %}
                <div class="swiper-slide">
                    <div class="card-minimal">
                        
                        <button onclick="toggleFav(this, {{ p.id }})" 
                                style="position: absolute; top: 10px; right: 10px; z-index: 10; background: white; border-radius: 50%; width: 35px; height: 35px; border: 1px solid #eee; cursor: pointer; display:flex; align-items:center; justify-content:center; box-shadow: 0 2px 5px rgba(0,0,0,0.05);">
                            {% if p.id in productos_favoritos_ids %}
                                <i class="fas fa-heart" style="color: #ff4b9a; font-size: 1.1rem;"></i>
                            {% else %}
                                <i class="far fa-heart" style="color: #ccc; font-size: 1.1rem;"></i>
                            {% endif %}
                        </button>

                        <a href="{% url 'detalle_producto' p.id %}" style="display: block; background: #fff; padding: 20px;">
                            {% if p.imagen %}
                                <img src="{{ p.imagen.url }}" style="width: 100%; height: 200px; object-fit: contain;" alt="{{ p.nombre }}">
                            {% else %}
                                <div style="height: 200px; background: #f9f9f9; display: flex; align-items: center; justify-content: center; color: #eee; border-radius: 10px;">
                                    <i class="fas fa-camera fa-3x"></i>
                                </div>
                            {% endif %}
                        </a>

                        <div style="padding: 15px; text-align: center; display: flex; flex-direction: column; flex-grow: 1;">
                            
                            {% if p.marca %}
                                <small style="color: #999; font-size: 0.75rem; text-transform: uppercase; letter-spacing: 1px; margin-bottom: 5px;">{{ p.marca.nombre }}</small>
                            {% endif %}

                            <a href="{% url 'detalle_producto' p.id %}" style="font-size: 1rem; font-weight: 600; color: #333; margin-bottom: 10px; text-decoration: none; line-height: 1.3; height: 42px; overflow: hidden; display: -webkit-box; -webkit-line-clamp: 2; -webkit-box-orient: vertical;">
                                {{ p.nombre }}
                            </a>

                            <div style="color: #333; font-weight: 800; font-size: 1.2rem; margin-bottom: 15px;">
                                ${{ p.precio }}
                            </div>
                            
                            <div style="margin-top: auto; display: flex; flex-direction: column; gap: 8px;">
                                <a href="{% url 'detalle_producto' p.id %}" class="btn-outline-minimal">
                                    Ver Detalles
                                </a>
                                
                            {% if user.is_authenticated %}
    
                            {% if p.variacion_set.exists %}
                                <a href="{% url 'detalle_producto' p.id %}" class="btn-black-minimal" style="display:block; text-align:center; padding:10px;">
                                    Seleccionar Opciones
                                </a>
                                {% else %}
                                   <form method="POST" action="{% url 'agregar_carrito' p.id %}" class="form-agregar-ajax">
                                {% csrf_token %}
                                <input type="hidden" name="cantidad" value="1">
                                <button type="submit" class="btn-black-minimal">
                                Agregar al Carrito
                                </button>
                                    </form>
                            {% endif %}
                                {% else %}  
                                <a href="{% url 'login' %}" style="font-size: 0.8rem; color: #999; text-decoration: underline;">
                                  Login para comprar
                                </a>
                            {% endif %}
                            </div>
                        </div>
                    </div>
                </div>
                {% endfor %}
                </div>

            <div class="swiper-button-next" style="color: #ff4b9a; font-weight: bold;"></div>
            <div class="swiper-button-prev" style="color: #ff4b9a; font-weight: bold;"></div>
            <div class="swiper-pagination"></div>
        </div>
    </div>
</section>

<script src="https://cdn.jsdelivr.net/npm/swiper@11/swiper-bundle.min.js"></script>
<script>
    var swiper = new Swiper(".mySwiper", {
        slidesPerView: 1,      // Empieza con 1 en celular
        spaceBetween: 20,      // Espacio entre tarjetas
        loop: true,            // Infinito
        pagination: {
            el: ".swiper-pagination",
            clickable: true,
        },
        navigation: {
            nextEl: ".swiper-button-next",
            prevEl: ".swiper-button-prev",
        },
        breakpoints: {
            640: { slidesPerView: 2, spaceBetween: 20 }, // Tablet pequeña: 2 productos
            768: { slidesPerView: 3, spaceBetween: 30 }, // Tablet normal: 3 productos
            1024: { slidesPerView: 4, spaceBetween: 30 }, // PC: 4 productos (ESTO ARREGLA EL TAMAÑO GIGANTE)
        },
    });
</script>
<style>
    /* Estilo de seguridad para que no se vea gigante si falla JS */
    .swiper-slide { height: auto; }
    .swiper-button-next::after, .swiper-button-prev::after { font-size: 1.5rem; }
    .swiper-pagination-bullet-active { background: #ff4b9a !important; }
</style>
</section>
{% else %}
    <div class="results-header">
        <h2 style="color: {% if query %}#ba68c8{% else %}#ff4b9a{% endif %}; font-size: 2rem;">
            {% if query %}Resultados para "<strong>{{ query }}</strong>"{% else %}Explora el Catálogo{% endif %}
        </h2>
        <p class="text-muted" style="font-size: 1.1rem;">{{ productos|length }} productos encontrados</p>
    </div>
{% endif %}

<div class="catalog-wrapper" id="catalogo">
    <aside class="filter-sidebar">
        <form id="filterForm" method="GET" action="{% url 'home' %}#catalogo">
            {% if query %}<input type="hidden" name="q" value="{{ query }}">{% endif %}
            <input type="hidden" name="orden" id="hiddenOrden" value="{{ orden_actual|default:'relevancia' }}">

            <div class="filter-header">
                <span class="filter-title"><i class="fas fa-sliders-h" style="color:#ff4b9a;"></i> Filtros</span>
                <a href="{% url 'home' %}" style="font-size:0.8rem; color:#ba68c8; text-decoration:underline;">Limpiar</a>
            </div>

            <details class="filter-group" open>
                <summary>Precio</summary>
                <div style="text-align:center; padding:10px 0;">
                    <div class="price-row">
                        <input type="number" name="min_precio" id="inputMin" class="price-input" value="{{ filtro_min|floatformat:0 }}">
                        <span>-</span>
                        <input type="number" name="max_precio" id="inputMax" class="price-input" value="{{ filtro_max|floatformat:0 }}">
                    </div>
                    <input type="range" min="{{ precio_min_global|floatformat:0 }}" max="{{ precio_max_global|floatformat:0 }}" 
                           value="{{ filtro_min|floatformat:0 }}" style="width:100%; accent-color:#ff4b9a;"
                           oninput="document.getElementById('inputMin').value = this.value">
                    <button type="submit" class="btn-apply">Aplicar Precio</button>
                </div>
            </details>

            {% for cat in categorias %}
            <details class="filter-group" {% if cat.id in cats_selected %}open{% endif %}>
                <summary>{{ cat.nombre }}</summary>
                <div style="padding: 10px 0;">
                    <div class="checkbox-item">
                        <input type="checkbox" name="categoria" value="{{ cat.id }}" id="cat_{{ cat.id }}" class="single-check" 
                               {% if cat.id in cats_selected %}checked{% endif %} onclick="oneCheck(this); this.form.submit()">
                        <label style="font-weight:bold; color:#ff4b9a;">Todo {{ cat.nombre }}</label>
                    </div>
                    {% for sub in cat.subcategorias.all %}
                        <div style="font-size:0.75rem; color:#ba68c8; font-weight:800; margin:10px 0 5px 5px;">{{ sub.nombre|upper }}</div>
                        {% for tipo in sub.tipos.all %}
                        <div class="checkbox-item" style="padding-left:10px;">
                            <input type="checkbox" name="tipo" value="{{ tipo.id }}" class="single-check"
                                   {% if tipo.id in tipos_selected %}checked{% endif %} onclick="oneCheck(this); this.form.submit()">
                            <label>{{ tipo.nombre }}</label>
                        </div>
                        {% endfor %}
                    {% endfor %}
                </div>
            </details>
            {% endfor %}
            
            <details class="filter-group" {% if marcas_selected %}open{% endif %}>
                <summary>Marcas</summary>
                <div style="padding:10px 0; max-height:200px; overflow-y:auto;">
                    {% for m in marcas %}
                    <div class="checkbox-item">
                        <input type="checkbox" name="marca" value="{{ m.marca__id }}" class="single-check"
                               {% if m.marca__id in marcas_selected %}checked{% endif %} onclick="oneCheck(this); this.form.submit()">
                        <label>{{ m.marca__nombre }}</label>
                    </div>
                    {% endfor %}
                </div>
            </details>
        </form>
    </aside>

    <main>
        <div style="display:flex; justify-content:flex-end; margin-bottom:20px; align-items:center; gap:10px;">
            <label style="font-size:0.9rem; font-weight:600; color:#666;">Ordenar:</label>
            <select style="border:1px solid #ddd; padding:8px 15px; border-radius:50px; outline:none; cursor:pointer;"
                    onchange="document.getElementById('hiddenOrden').value=this.value; document.getElementById('filterForm').submit();">
                <option value="relevancia" {% if orden_actual == 'relevancia' %}selected{% endif %}>Relevancia</option>
                <option value="precio_bajo" {% if orden_actual == 'precio_bajo' %}selected{% endif %}>Precio: Bajo a Alto</option>
                <option value="precio_alto" {% if orden_actual == 'precio_alto' %}selected{% endif %}>Precio: Alto a Bajo</option>
            </select>
        </div>

   <div class="products-grid">
    {% for p in productos %}
    <div class="card-minimal" style="background: white; border-radius: 15px; border: 1px solid #f0f0f0; overflow: hidden; position: relative; transition: all 0.3s ease; display: flex; flex-direction: column; height: 100%;">
        
        <button onclick="toggleFav(this, {{ p.id }})" 
                style="position: absolute; top: 10px; right: 10px; z-index: 10; background: white; border-radius: 50%; width: 35px; height: 35px; border: 1px solid #eee; cursor: pointer; display:flex; align-items:center; justify-content:center; box-shadow: 0 2px 5px rgba(0,0,0,0.05);">
            {% if p.id in productos_favoritos_ids %}
                <i class="fas fa-heart" style="color: #ff4b9a; font-size: 1.1rem;"></i>
            {% else %}
                <i class="far fa-heart" style="color: #ccc; font-size: 1.1rem;"></i>
            {% endif %}
        </button>

        <a href="{% url 'detalle_producto' p.id %}" style="display: block; background: #fff; padding: 20px; text-align: center;">
            {% if p.imagen %}
                <img src="{{ p.imagen.url }}" style="width: 100%; height: 200px; object-fit: contain;" alt="{{ p.nombre }}">
            {% else %}
                <div style="height: 200px; background: #f9f9f9; display: flex; align-items: center; justify-content: center; color: #eee; border-radius: 10px;">
                    <i class="fas fa-camera fa-3x"></i>
                </div>
            {% endif %}
        </a>

        <div style="padding: 15px; text-align: center; display: flex; flex-direction: column; flex-grow: 1;">
            
            {% if p.marca %}
                <small style="color: #999; font-size: 0.75rem; text-transform: uppercase; letter-spacing: 1px; margin-bottom: 5px;">{{ p.marca.nombre }}</small>
            {% endif %}

            <a href="{% url 'detalle_producto' p.id %}" style="font-size: 1rem; font-weight: 600; color: #333; margin-bottom: 10px; text-decoration: none; line-height: 1.3; height: 42px; overflow: hidden; display: -webkit-box; -webkit-line-clamp: 2; -webkit-box-orient: vertical;">
                {{ p.nombre }}
            </a>

            <div style="color: #333; font-weight: 800; font-size: 1.2rem; margin-bottom: 15px;">
                ${{ p.precio }}
            </div>
            
            <div style="margin-top: auto; display: flex; flex-direction: column; gap: 8px;">
    
    <a href="{% url 'detalle_producto' p.id %}" style="display: block; width: 100%; padding: 8px; background: transparent; color: #666; border: 1px solid #ddd; border-radius: 8px; font-size: 0.85rem; text-decoration: none; transition: 0.3s;" onmouseover="this.style.borderColor='#ff4b9a'; this.style.color='#ff4b9a'" onmouseout="this.style.borderColor='#ddd'; this.style.color='#666'">
        Ver Detalles
    </a>
    
    {% if p.stock <= 0 %}
        <button disabled style="width: 100%; padding: 10px; background: #e0e0e0; color: #999; border: none; border-radius: 8px; font-weight: bold; cursor: not-allowed;">
            Agotado <i class="fas fa-ban"></i>
        </button>

    {% else %}
        {% if user.is_authenticated %}
            
            {% if p.variacion_set.exists %}
                <a href="{% url 'detalle_producto' p.id %}" class="btn-black-minimal" style="display:block; text-align:center; padding:10px;">
                    Seleccionar Opciones
                </a>

            {% else %}
                <form method="POST" action="{% url 'agregar_carrito' p.id %}" class="form-agregar-ajax">
                    {% csrf_token %}
                    <input type="hidden" name="cantidad" value="1">
                    <button type="submit" class="btn-black-minimal">
                        Agregar al Carrito
                    </button>
                </form>
            {% endif %} {% else %}
            <a href="{% url 'login' %}" style="font-size: 0.8rem; color: #999; text-decoration: underline;">
                Inicia sesión para comprar
            </a>
        {% endif %} {% endif %} </div>
</div>
</div>
{% endfor %}
    </main>
</div>

<script>
    function scrollSlider(d) { document.getElementById('newArrivalsSlider').scrollBy({ left: 240 * d, behavior: 'smooth' }); }
    function oneCheck(cb) { var cbs = document.getElementsByClassName('single-check'); for(var i=0; i<cbs.length; i++) { if(cbs[i]!==cb) cbs[i].checked=false; } }
    function toggleFav(btn) {
        btn.classList.toggle('active');
        let icon = btn.querySelector('i');
        if (btn.classList.contains('active')) {
            icon.classList.remove('far'); icon.classList.add('fas');
        } else {
            icon.classList.remove('fas'); icon.classList.add('far');
        }
    }
</script>
<script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
<script>
    document.querySelectorAll('.form-agregar-ajax').forEach(form => {
        form.addEventListener('submit', function(e) {
            e.preventDefault();
            var formData = new FormData(this);
            fetch(this.action, {
                method: 'POST',
                body: formData,
                headers: {'X-Requested-With': 'XMLHttpRequest'}
            })
            .then(response => response.json())
            .then(data => {
                if(data.status === 'true') {
                    Swal.fire({
                        icon: 'success', title: '¡Agregado!',
                        text: 'Producto añadido al carrito',
                        toast: true, position: 'top-end', showConfirmButton: false, timer: 3000
                    });
                } else {
                    Swal.fire({icon: 'error', title: 'Ups...', text: data.message});
                }
            })
            .catch(error => console.error('Error:', error));
        });
    });
</script>

<script>
    document.addEventListener("DOMContentLoaded", function() {
        // Solo si la pantalla es menor a 900px
        if (window.innerWidth < 900) {
            var sidebar = document.querySelector('.filter-sidebar');
            var wrapper = document.querySelector('.catalog-wrapper');

            if (sidebar && wrapper) {
                // 1. Crear el botón
                var btn = document.createElement('button');
                btn.innerHTML = '<i class="fas fa-filter"></i> MOSTRAR FILTROS';
                
                // 2. Estilo del botón (Negro elegante)
                btn.style.width = '100%';
                btn.style.padding = '12px';
                btn.style.background = '#333';
                btn.style.color = 'white';
                btn.style.border = 'none';
                btn.style.borderRadius = '50px';
                btn.style.fontWeight = 'bold';
                btn.style.marginBottom = '15px';
                btn.style.cursor = 'pointer';
                btn.style.fontSize = '0.9rem';

                // 3. Insertar el botón antes del sidebar
                wrapper.insertBefore(btn, sidebar);

                // 4. Acción al hacer clic
                btn.addEventListener('click', function(e) {
                    e.preventDefault();
                    if (sidebar.style.display === 'block' || sidebar.classList.contains('active')) {
                        sidebar.classList.remove('active');
                        sidebar.style.display = 'none';
                        btn.innerHTML = '<i class="fas fa-filter"></i> MOSTRAR FILTROS';
                        btn.style.background = '#333';
                    } else {
                        sidebar.classList.add('active');
                        sidebar.style.display = 'block';
                        btn.innerHTML = '<i class="fas fa-times"></i> OCULTAR FILTROS';
                        btn.style.background = '#ba68c8'; // Se pone morado al abrir
                    }
                });
            }
        }
    });
</script>

{% endblock %}