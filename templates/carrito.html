{% extends "base.html" %}
{% load static %}

{% block content %}
<script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
<script src="https://html2canvas.hertzen.com/dist/html2canvas.min.js"></script>
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
<link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css"/>
<script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
<link href="https://fonts.googleapis.com/css2?family=Manrope:wght@400;600;800&family=Poppins:wght@300;500;700;800&display=swap" rel="stylesheet">

<style>
    :root { --primary: #ba68c8; --secondary: #ff4b9a; --dark: #333; --bg: #f3f4f6; }
    body { background-color: var(--bg); font-family: 'Manrope', sans-serif; color: var(--dark); }
    .leaflet-control-attribution { display: none !important; }
    .swal2-container { z-index: 200000 !important; }

    /* BOT√ìN FLOTANTE */
    .btn-header-fixed { position: fixed; top: 90px; right: 40px; z-index: 99999; background-color: #fff; color: #d63384; border: 2px solid #fff; padding: 6px 18px; border-radius: 30px; font-weight: 800; font-size: 0.85rem; cursor: pointer; display: flex; align-items: center; gap: 6px; text-decoration: none; box-shadow: 0 4px 12px rgba(0,0,0,0.2); transition: 0.3s; }
    .btn-header-fixed:hover { background-color: #fce4ec; transform: scale(1.05); }

    /* MENSAJES (NOTIFICACIONES) */
    .django-msg-container { position: fixed; top: 20px; right: 20px; z-index: 999999; }
    .django-msg { padding: 15px 20px; border-radius: 10px; color: white; margin-bottom: 10px; box-shadow: 0 5px 15px rgba(0,0,0,0.2); animation: slideIn 0.5s ease; font-weight: bold; }
    .msg-success { background: #10b981; } .msg-warning { background: #f59e0b; } .msg-error { background: #ef4444; }
    @keyframes slideIn { from { transform: translateX(100%); } to { transform: translateX(0); } }

    /* BADGES Y BOTONES */
    .badge-status { padding: 4px 10px; border-radius: 12px; font-size: 0.7rem; font-weight: 800; text-transform: uppercase; display:inline-block; margin-left: auto; }
    .st-pendiente { background-color: #fff3cd; color: #856404; } .st-entregado { background-color: #d1e7dd; color: #0f5132; } .st-cancelado { background-color: #f8d7da; color: #721c24; }
    .btn-delete-vis { background: #dc3545; color: white; border: none; width: 36px; height: 36px; border-radius: 10px; display: flex; align-items: center; justify-content: center; cursor: pointer; transition: 0.2s; margin-left: 10px; }
    
    /* LAYOUT */
    .checkout-container { max-width: 1250px; margin: 40px auto; padding: 0 20px; display: grid; grid-template-columns: 1.6fr 1fr; gap: 35px; align-items: start; }
    .white-box { background: white; border-radius: 24px; padding: 35px; box-shadow: 0 10px 30px rgba(0,0,0,0.03); border: 1px solid #fff; }
    
    /* STEPPER */
    .stepper { display: flex; justify-content: center; gap: 50px; margin-bottom: 30px; border-bottom: 2px solid #f0f0f0; padding-bottom: 20px; }
    .step-item { display: flex; align-items: center; gap: 10px; opacity: 0.4; transition: 0.3s; font-weight: 600; }
    .step-item.active { opacity: 1; transform: scale(1.05); color: var(--primary); }
    .step-num { width: 35px; height: 35px; background: #eee; border-radius: 50%; display: flex; align-items: center; justify-content: center; font-weight: 800; }
    .step-item.active .step-num { background: var(--primary); color: white; box-shadow: 0 4px 12px rgba(186, 104, 200, 0.3); }
    .step-view { display: none; } .step-view.current { display: block; }

    /* PRODUCTOS */
    .prod-row { display: flex; align-items: center; border-bottom: 1px dashed #eee; padding: 15px 0; }
    .prod-img { width: 70px; height: 70px; border-radius: 12px; object-fit: cover; border: 1px solid #eee; margin-right: 15px; }
    .tone-badge { display: inline-block; background: #fae8ff; color: #a21caf; font-size: 0.75rem; padding: 3px 10px; border-radius: 20px; font-weight: 700; margin-bottom: 5px; }
    .qty-control { display: inline-flex; align-items: center; background: #f8fafc; border-radius: 50px; padding: 4px; gap: 10px; border:1px solid #e2e8f0; margin-top: 10px; }
    .qty-btn { width: 26px; height: 26px; background: white; border-radius: 50%; border: none; cursor: pointer; display: flex; align-items: center; justify-content: center; font-weight: bold; color: #333; text-decoration: none; }
    .prod-price { font-weight: 800; font-size: 1.1rem; margin-left: 20px; color: var(--primary); }
    
    /* FORMULARIO Y MAPA */
    .form-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 20px; }
    .full { grid-column: span 2; }
    .lbl { display: block; margin-bottom: 6px; font-weight: 700; font-size: 0.8rem; color: #64748b; text-transform: uppercase; }
    .inp { width: 100%; padding: 14px; border: 2px solid #e2e8f0; border-radius: 12px; font-size: 0.95rem; background:#f8fafc; transition:0.3s; }
    .error-msg { color: #e91e63; font-size: 0.75rem; font-weight: 700; margin-top: 5px; display: none; }
    .inp.error-border { border-color: #e91e63 !important; background-color: #fff0f3 !important; }
    #map-box { height: 300px; width: 100%; border-radius: 16px; margin-top: 15px; border: 4px solid white; box-shadow: 0 10px 25px rgba(0,0,0,0.05); z-index: 1; display: block; }
    
    /* CAJA DE PAGO E INFO */
    .transfer-box { background: #fff; border: 2px dashed #cbd5e1; border-radius: 16px; padding: 30px; display: flex; justify-content: space-between; align-items: center; }
    .msg-alert { background: #e3f2fd; color: #0d47a1; padding: 20px; border-radius: 12px; font-size: 0.9rem; margin-top: 25px; display: flex; align-items: center; gap: 20px; border: 1px solid #bbdefb; }
    
    /* TOTALES Y BOT√ìN */
    .right-sticky { position: sticky; top: 30px; }
    .total-big { font-size: 2.2rem; font-weight: 900; text-align: right; margin-top: 20px; border-top: 2px dashed #eee; padding-top: 15px; color: #1e293b; }
    .btn-main { width: 100%; padding: 18px; background: #1e293b; color: white; border: none; border-radius: 14px; font-size: 1rem; font-weight: 800; cursor: pointer; margin-top: 25px; text-transform: uppercase; transition: 0.3s; }
    .btn-main:hover { background: #000; }

    /* MODAL */
    .modal-overlay { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.6); z-index: 10000; display: none; align-items: center; justify-content: center; backdrop-filter: blur(3px); }
    .modal-box { background: white; width: 95%; max-width: 650px; border-radius: 20px; padding: 30px; max-height: 85vh; overflow-y: auto; position: relative; }
    .close-btn { position: absolute; top: 20px; right: 25px; font-size: 2rem; cursor: pointer; color: #aaa; }
    .order-card { border: 1px solid #eee; padding: 20px; border-radius: 15px; margin-bottom: 12px; background: #fdfdfd; display: flex; flex-direction:column; gap:10px; }
    .oc-footer { display: flex; align-items: center; gap: 10px; margin-top: 10px; }
    .btn-reprint { flex:1; background: #333; color: white; border: none; padding: 10px; border-radius: 8px; cursor: pointer; font-weight: bold; }
    
    #receipt-phantom { position: fixed; left: -9999px; } /* Oculto para PDF */
    /* --- ADAPTABILIDAD PARA CELULARES (RESPONSIVE) --- */
   /* --- ARREGLO DE EMERGENCIA: ENCABEZADO FIJO --- */
    @media (max-width: 900px) {

        /* 1. EL CONTENEDOR PRINCIPAL */
        .header-top {
            display: flex !important;
            flex-wrap: wrap !important; /* Permite que el buscador baje */
            align-items: center !important;
            padding: 10px 10px 5px 10px !important; /* Espacio para no chocar */
            position: relative !important; /* Necesario para el truco */
            min-height: 50px !important;
        }

        /* 2. EL LOGO (Izquierda) */
        .brand-badge {
            order: 1;
            width: auto !important;
            max-width: 60% !important; /* Le dejamos el 60% del espacio */
            margin-right: auto !important;
            display: flex; align-items: center;
        }
        .brand-badge img { width: 35px; height: 35px; }
        .brand-badge span { font-size: 1.1rem !important; margin-left: 5px; white-space: nowrap; }

        /* 3. LOS ICONOS (TRUCO: LOS PEGAMOS A LA DERECHA A LA FUERZA) */
        /* Agrupamos visualmente los √≠conos y la bolsa */
        
        /* Grupo de Iconos (Coraz√≥n, Tuerca) */
        .header-actions {
            position: absolute !important; /* Flotan sobre todo */
            top: 15px !important;          /* Alineados arriba */
            right: 50px !important;        /* Dejan espacio para la bolsa */
            margin: 0 !important; padding: 0 !important;
            width: auto !important;
            background: transparent !important;
            gap: 5px !important;
            display: flex !important;
        }

        /* La Bolsa de Carrito (En la mera esquina) */
        a[title="Ver Carrito"], .header-top > a.icon-btn[href*="carrito"] {
            position: absolute !important;
            top: 15px !important;
            right: 10px !important; /* Pegado al borde derecho */
            margin: 0 !important;
            display: flex !important;
        }

        /* 4. BUSCADOR (Abajo) */
        .search-form {
            order: 3;
            width: 100% !important;
            margin-top: 15px !important; /* Un poco de aire arriba */
            flex: 0 0 100% !important;
        }

        /* TAMA√ëOS PEQUE√ëOS PARA QUE NO CHOQUEN */
        .icon-btn, .header-actions i, a[title="Ver Carrito"] i { font-size: 1.2rem !important; color: #555 !important; }
        .header-actions span, .header-actions a[title="Sobre Nosotros"] { display: none !important; }


        /* 5. BOT√ìN "MIS PEDIDOS" Y DEM√ÅS ARREGLOS */
        .btn-header-fixed {
            position: static !important;
            display: block !important;
            width: fit-content !important;
            margin: 10px auto 20px auto !important;
            background: white !important;
            color: #ff4b9a !important;
            border: 2px solid #ff4b9a !important;
            padding: 6px 20px !important;
            border-radius: 50px !important;
        }

        /* Lista de productos ordenada */
        .checkout-container { display: block !important; padding: 10px !important; }
        .white-box { width: 100% !important; padding: 15px !important; margin-bottom: 20px !important; }
        .prod-row { display: flex !important; align-items: center !important; justify-content: space-between !important; padding: 10px 0; }
        .prod-img { width: 50px !important; height: 50px !important; object-fit: contain !important; margin-right: 10px; }
        .prod-row div:nth-child(2) { flex: 1; }
        .form-grid { display: block !important; }
        .form-grid > div { width: 100% !important; margin-bottom: 10px; }
        
        body, html { overflow-x: hidden !important; width: 100% !important; }
    }
</style>

<a href="#" onclick="toggleModal('ordersModal')" class="btn-header-fixed"><i class="fas fa-box-open"></i> Mis Pedidos</a>

<div class="checkout-container">
    {% if not carrito %}
        <div class="white-box" style="grid-column: 1 / -1; text-align:center; padding: 80px;">
            <i class="fas fa-shopping-basket fa-5x" style="color:#eee; margin-bottom:25px;"></i>
            <h2>Tu carrito est√° vac√≠o</h2>
            <a href="{% url 'home' %}" class="btn-main" style="display:inline-block; width:auto; padding:15px 50px; text-decoration:none;">Ir a comprar</a>
        </div>
    {% else %}

    <div class="white-box" style="min-height: 600px;">
        <div class="stepper">
            <div class="step-item active" id="st-1"><div class="step-num">1</div><div>Pedido</div></div>
            <div class="step-item" id="st-2"><div class="step-num">2</div><div>Datos</div></div>
            <div class="step-item" id="st-3"><div class="step-num">3</div><div>Pago</div></div>
        </div>

        <form action="{% url 'procesar_pedido' %}" method="POST" id="main-form">
            {% csrf_token %}
            <input type="hidden" name="metodo_pago" value="Transferencia">
            <input type="hidden" name="total_final" id="input_total">
            <input type="hidden" name="ref_pedido" id="ref_pedido_input">
            <input type="hidden" name="ubicacion_lat" id="lat">
            <input type="hidden" name="ubicacion_lng" id="lng">
            <input type="hidden" name="map_link" id="map_link">

            <div id="view-1" class="step-view current">
                <h3 style="margin-bottom:25px;">Tu Carrito</h3>
                {% for key, item in carrito.carrito.items %}
                <div class="prod-row">
                {% if item.imagen %} 
                <img src="{{ item.imagen }}" class="prod-img"> 
                {% else %} 
                <div class="prod-img" style="background:#eee;"></div> 
                {% endif %}
    
                <div style="flex:1;">
                <div style="font-weight:800; font-size:1.05rem;">{{ item.nombre }}</div>

                {% if item.variacion %} 
                <span class="tone-badge" style="background:#fae8ff; color:#d946ef; padding:2px 8px; border-radius:10px; font-size:0.8rem; font-weight:bold;">
                Tono: {{ item.variacion }}
                </span>
                {% endif %}
        
        <div class="qty-control" style="margin-top:5px;">
            <a href="{% url 'restar' item.producto_id %}?variacion={{ item.variacion_id }}" class="qty-btn">-</a>
            
            <span style="margin:0 10px; font-weight:bold;">{{ item.cantidad }}</span>
            
            <a href="{% url 'sumar' item.producto_id %}?variacion={{ item.variacion_id }}" class="qty-btn">+</a>
        </div>
    </div>
    
    <div class="prod-price" style="font-weight:bold; color:#ff4b9a; font-size:1.1rem; margin-left:15px;">
        ${{ item.subtotal }}
    </div>

    <a href="{% url 'eliminar' item.producto_id %}?variacion={{ item.variacion_id }}" style="color:#ff6b6b; font-size:1.2rem; margin-left:20px;">
        <i class="fas fa-trash-alt"></i>
    </a>
</div>
{% endfor %}
            </div>

            <div id="view-2" class="step-view">
                <h3 style="margin-bottom:25px;">Datos de Env√≠o</h3>
                <div class="form-grid">
                    <div class="full">
        <label class="lbl">Nombre Completo</label>
        <input type="text" name="nombre_destinatario" class="inp" 
               value="{{ user.first_name }} {{ user.last_name }}" 
               placeholder="Ej: Emilia P√©rez"
               onkeyup="validarVivo(this, 'texto', 5)">
        <small class="error-msg">‚ö†Ô∏è M√≠nimo 5 letras. No uses n√∫meros.</small>
    </div>

    <div>
        <label class="lbl">C√©dula / RUC</label>
        <input type="tel" name="cedula" class="inp" 
               placeholder="Solo n√∫meros" maxlength="13"
               onkeyup="validarVivo(this, 'numero', 10)">
        <small class="error-msg">‚ö†Ô∏è M√≠nimo 10 n√∫meros.</small>
    </div>

    <div>
        <label class="lbl">Tel√©fono</label>
        <input type="tel" name="telefono" class="inp" 
               placeholder="099..." maxlength="10"
               onkeyup="validarVivo(this, 'numero', 10)">
        <small class="error-msg">‚ö†Ô∏è 10 d√≠gitos (empieza con 09).</small>
    </div>

    <div>
        <label class="lbl">Provincia</label>
        <input type="text" name="provincia" class="inp" 
               value="Santa Elena"
               onkeyup="validarVivo(this, 'texto', 4)">
        <small class="error-msg">‚ö†Ô∏è Provincia requerida.</small>
    </div>

    <div>
        <label class="lbl">Ciudad / Cant√≥n</label>
        <input type="text" name="canton" class="inp" 
               onkeyup="validarVivo(this, 'texto', 3)">
        <small class="error-msg">‚ö†Ô∏è Ciudad requerida.</small>
    </div>

    <div class="full">
        <label class="lbl">Barrio / Sector</label>
        <input type="text" name="barrio" class="inp" 
               placeholder="Ej: Barrio Central"
               onkeyup="validarVivo(this, 'texto', 5)">
        <small class="error-msg">‚ö†Ô∏è El barrio es muy corto.</small>
    </div>

    <div class="full">
        <label class="lbl">Direcci√≥n Exacta</label>
        <input type="text" name="calle_p" class="inp" 
               placeholder="Calle principal, secundaria y n√∫mero"
               onkeyup="validarVivo(this, 'texto', 8)">
        <small class="error-msg">‚ö†Ô∏è Detalla tu direcci√≥n (m√≠nimo 8 letras).</small>
    </div>

    <div class="full">
        <label class="lbl">Referencia (Opcional)</label>
        <input type="text" name="referencia" 
               placeholder="Frente a...">
    </div>
                </div>
                <div style="margin-top:30px;">
                    <label class="lbl" style="color:var(--primary); font-size:0.9rem;"><i class="fas fa-map-marker-alt"></i> UBICACI√ìN EXACTA (Mueve el Pin):</label>
                    <div id="map-box"></div> 
                </div>
            </div>

            <div id="view-3" class="step-view">
                <h3 style="margin-bottom:25px;">Pago por Transferencia</h3>
                <div class="transfer-box">
                    <div>
                        <h4 style="margin:0 0 10px 0; color:var(--primary);">Banco Guayaquil</h4>
                        <p style="margin:5px 0;">Cta. Ahorros: <strong>34556941</strong></p>
                        <p style="margin:5px 0;">Titular: <strong>Shirley de la Rosa.</strong></p>
                        <p style="margin:5px 0;">CI: <strong>0923402499</strong></p>
                    </div>
                    <div style="text-align:center;">
                        <i class="fas fa-qrcode fa-4x" style="color:#eee;"></i>
                    </div>
                </div>
                <div class="msg-alert">
                    <i class="fas fa-info-circle fa-2x"></i>
                    <div>
                        <strong>¬°Casi listo! Sigue estos pasos:</strong><br>
                        1. Realiza la transferencia bancaria.<br>
                        2. Presiona "FINALIZAR" para guardar tu pedido.<br>
                        3. Autom√°ticamente se abrir√° <b>WhatsApp</b> para que nos env√≠es tu comprobante y el detalle de tu compra.
                        <br><br>
                        <small>* Tambi√©n podr√°s descargar tu Orden de Compra (PDF) en el bot√≥n <b>"Mis Pedidos"</b>.</small>
                    </div>
                </div>
            </div>
        </form>
    </div>

    <div class="white-box right-sticky">
    <h3 style="margin-top:0;">Resumen</h3>
    <div class="sum-row"><span>Subtotal</span> <span>${{ importe_total_carrito }}</span></div>
    
    <div class="sum-row"><span>Env√≠o Fijo</span> <span style="color:var(--primary);">+${{ costo_envio }}</span></div>
    
    <div class="total-big">Total: $<span id="lbl-total">{{ total_con_envio }}</span></div>

    {% if alerta_stock %}
        <div style="background:#fee2e2; color:#b91c1c; padding:15px; border-radius:8px; text-align:center; font-weight:bold; margin-bottom:15px; border: 1px solid #ef4444;">
            <i class="fas fa-exclamation-triangle"></i> Hay productos sin stock suficiente.<br>
            <small style="font-weight:normal;">Por favor, reduce la cantidad para continuar.</small>
        </div>
    {% else %}
        <button type="button" class="btn-main" id="btn-next" onclick="nextStep()">CONTINUAR <i class="fas fa-arrow-right"></i></button>
    {% endif %}
    <button type="button" class="btn-main" id="btn-back" onclick="prevStep()" style="display:none; background:transparent; color:#999; border:2px solid #eee; margin-top:15px;">Volver</button>
    </div>
    {% endif %}
</div>

<div id="ordersModal" class="modal-overlay">
    <div class="modal-box">
        <span class="close-btn" onclick="toggleModal('ordersModal')">√ó</span>
        <h2 style="color:var(--primary); margin-bottom:20px;">üì¶ Mis Pedidos</h2>
        {% if pedidos_usuario %}
            {% for p in pedidos_usuario %}
            <div class="order-card">
                <div class="oc-header">
                    <h4 style="margin:0; font-weight:800; color:#333;">N¬∫ {{ p.id|stringformat:"04d" }}</h4>
                    <span class="badge-status {% if p.estado == 'PENDIENTE' %}st-pendiente{% elif p.estado == 'ENTREGADO' %}st-entregado{% else %}st-cancelado{% endif %}">{{ p.estado }}</span>
                </div>
                <div style="margin-top:8px;">
                    <p style="margin:0; color:#666; font-size:0.9rem;">{{ p.fecha|date:"d/m/Y" }} | <strong>${{ p.total }}</strong></p>
                </div>
                <div class="oc-footer">
                    <a href="{% url 'descargar_comprobante' p.id %}" class="btn-reprint" style="text-decoration:none; text-align:center;">
                        <i class="fas fa-download"></i> Descargar Orden de Compra
                    </a>
                    {% if p.estado == 'ENTREGADO' %}
                        <button class="btn-delete-vis" onclick="confirmDelete('{{ p.id }}')"><i class="fas fa-trash-alt"></i></button>
                        <form id="delete-form-{{ p.id }}" action="{% url 'eliminar_pedido' p.id %}" method="POST" style="display:none;">{% csrf_token %}</form>
                    {% endif %}
                </div>
            </div>
            {% endfor %}
        {% else %}
            <p style="text-align:center; padding:40px; color:#999;">No tienes pedidos registrados.</p>
        {% endif %}
    </div>
</div>

<script>
    // Inicializar total
    const totalRaw = "{{ importe_total_carrito|default:'0' }}".replace(',', '.');
    const totalCalc = (parseFloat(totalRaw)).toFixed(2);
    if(document.getElementById('lbl-total')) document.getElementById('lbl-total').innerText = totalCalc;
    if(document.getElementById('input_total')) document.getElementById('input_total').value = totalCalc;

    let step = 1, map, marker, mapLinkUrl = "";

    function toggleModal(id) { const m = document.getElementById(id); m.style.display = (m.style.display === 'flex') ? 'none' : 'flex'; }

    function nextStep() {
        if(step === 3) { finalProcess(); return; }
        
        // --- AQU√ç EMPIEZA EL CONTROL DEL PASO 2 ---
        if(step === 2) {
            const inputs = document.querySelectorAll('#view-2 input');
            let hayError = false;
            
            inputs.forEach(i => {
                // 1. Revisar si est√° vac√≠o (y no es opcional)
                if(i.placeholder.indexOf('(Opcional)') === -1 && i.value.trim() === '') {
                    i.classList.add('error-border');
                    if(i.nextElementSibling) i.nextElementSibling.style.display = 'block';
                    hayError = true;
                }
                // 2. Revisar si ya tiene error marcado (rojo)
                if(i.classList.contains('error-border')) {
                    hayError = true;
                }
            });

            if(hayError) { 
                Swal.fire({icon:'warning', title:'Atenci√≥n', text:'Corrige los campos en rojo antes de continuar.'}); 
                return; // ¬°AQU√ç SE FRENA SI EST√Å MAL!
            }
            
            if(!mapLinkUrl) { Swal.fire({icon:'warning', title:'Mapa', text:'Marca tu ubicaci√≥n en el mapa.'}); return; }
        }

        step++; 
        updateView();
    }

    // --- PEGA ESTO AL FINAL DE TUS SCRIPTS ---
    function validarVivo(input, tipo, min) {
        let valor = input.value;
        let esValido = true;
        let msg = input.nextElementSibling; // El mensaje oculto

        // 1. Limpieza (Borra lo que no sirve)
        if (tipo === 'numero') {
            if (/[^0-9]/.test(valor)) input.value = valor.replace(/[^0-9]/g, ''); 
        } else if (tipo === 'texto') {
            if (/[^a-zA-Z√°√©√≠√≥√∫√Å√â√ç√ì√ö√±√ë\s]/.test(valor)) input.value = valor.replace(/[^a-zA-Z√°√©√≠√≥√∫√Å√â√ç√ì√ö√±√ë\s]/g, ''); 
        }

        // 2. Verificar Longitud
        if (input.value.length > 0 && input.value.length < min) {
            esValido = false;
        }

        // 3. Mostrar/Ocultar Error
        if (!esValido) {
            msg.style.display = 'block';
            input.classList.add('error-border');
        } else {
            msg.style.display = 'none';
            input.classList.remove('error-border');
        }
    }

    function prevStep() { if(step > 1) { step--; updateView(); } }

    function updateView() {
        document.querySelectorAll('.step-view').forEach(el => el.classList.remove('current'));
        document.getElementById('view-' + step).classList.add('current');
        document.querySelectorAll('.step-item').forEach((el, idx) => el.classList.toggle('active', (idx+1)===step));
        const btn = document.getElementById('btn-next');
        const back = document.getElementById('btn-back');
        back.style.display = (step === 1) ? 'none' : 'block';
        if(step === 1) btn.innerHTML = "SIGUIENTE <i class='fas fa-arrow-right'></i>";
        else if(step === 2) btn.innerHTML = "IR AL PAGO <i class='fas fa-credit-card'></i>";
        else if(step === 3) btn.innerHTML = "FINALIZAR Y GUARDAR <i class='fas fa-check'></i>";
        if(step === 2) { setTimeout(() => { if(!map) initMap(); else map.invalidateSize(); }, 300); }
    }

    function initMap() {
        // Coordenadas Santa Elena aprox
        const lat = -2.226, lng = -80.858;
        map = L.map('map-box', {attributionControl: false}).setView([lat, lng], 14);
        L.tileLayer('https://server.arcgisonline.com/ArcGIS/rest/services/World_Imagery/MapServer/tile/{z}/{y}/{x}', {maxZoom: 18}).addTo(map);
        marker = L.marker([lat, lng], {draggable:true}).addTo(map);
        marker.on('dragend', function(e) { updatePos(e.target.getLatLng()); });
        map.on('click', function(e) { marker.setLatLng(e.latlng); updatePos(e.latlng); });
        setTimeout(() => { map.invalidateSize(); }, 300);
    }
    function updatePos(coord) {
        document.getElementById('lat').value = coord.lat;
        document.getElementById('lng').value = coord.lng;
        mapLinkUrl = `https://www.google.com/maps?q=${coord.lat},${coord.lng}`;
        document.getElementById('map_link').value = mapLinkUrl;
    }

    // --- FUNCI√ìN PRINCIPAL DE GUARDADO Y WHATSAPP ---
    function finalProcess() {
        const form = document.getElementById('main-form');
        const formData = new FormData(form);
        const ref = `WEB-${Date.now()}`;
        formData.set('ref_pedido', ref);

        Swal.fire({ title: 'Guardando...', didOpen:()=>{Swal.showLoading()} });

        fetch(form.action, {
            method: 'POST',
            body: formData,
            headers: {'X-CSRFToken': document.querySelector('[name=csrfmiddlewaretoken]').value}
        })
        .then(response => response.json()) // Esperamos JSON del views.py
        .then(data => {
            if(data.status === 'true') {
                // AQU√ç EST√Å LA L√ìGICA DEL BOT√ìN DE WHATSAPP
                Swal.fire({
                    icon: 'success',
                    title: '¬°Pedido Guardado!',
                    html: `
                        <p style="font-size:0.9rem;">Tu orden <b>#${data.pedido_id}</b> ha sido registrada.</p>
                        <p style="font-size:0.8rem; color:#666;">Puedes descargar el PDF en "Mis Pedidos".</p>
                        <div style="text-align: center;">
                        <p style="font-size: 1.1em;">Gracias por tu compra </p>
                        <hr style="margin: 10px 0; border: 0; border-top: 1px solid #eee;">
                        <p style="color: #555;">Hemos enviado un <b>correo de confirmaci√≥n</b> con el detalle de tu pedido.</p>
                        <div style="background: #f0fdf4; color: #166534; padding: 10px; border-radius: 6px; margin-top: 10px; font-size: 0.9em;">
                        <i class="fas fa-envelope"></i> Revisa tu bandeja de entrada.
                        </div>
                        </div>
                    `,
                    confirmButtonText: '<i class="fab fa-whatsapp"></i> Enviar Comprobante Ahora',
                    confirmButtonColor: '#25D366',
                    showCancelButton: true,
                    cancelButtonText: 'Cerrar'

                    
                }).then((result) => {
                    if (result.isConfirmed) {
                        const fono = "593996578334"; // TU N√öMERO
                        const total = document.getElementById('lbl-total').innerText;
                        const msg = `Hola Adrivo R., adjunto mi comprobante de pago.\n\n*ORDEN #${data.pedido_id}*\n*Total:* $${total}\n*Ubicaci√≥n:* ${mapLinkUrl}`;
                        window.open(`https://wa.me/${fono}?text=${encodeURIComponent(msg)}`, '_blank');
                    }
                    window.location.reload(); 
                });
            } else {
                Swal.fire('Error', data.message || 'No se pudo guardar.', 'error');
            }
        })
        .catch(err => Swal.fire('Error', 'Error de conexi√≥n', 'error'));
    }

    // Funci√≥n eliminar pedido (Si usas el bot√≥n rojo del historial)
    function confirmDelete(id) {
        Swal.fire({
            title: '¬øEliminar?', icon: 'warning', showCancelButton: true, confirmButtonColor: '#d33', confirmButtonText: 'S√≠'
        }).then((r) => { if (r.isConfirmed) document.getElementById('delete-form-' + id).submit(); })
    }
</script>
{% endblock %}