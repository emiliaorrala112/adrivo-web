{% extends "admin/base_site.html" %}
{% load static %}

{% block messages %}{% endblock %}

{% block content %}

<style>
    :root { --bg-dark: #1e1e2f; --brand-purple: #ba68c8; --action-teal: #00f2c3; }
    
    /* 2. ARREGLO DE ALTURA (SOLUCI√ìN AL ESPACIO EN BLANCO) */
    .pos-wrapper { 
        display: flex; 
        gap: 20px; 
        /* Calcula: 100% pantalla menos cabecera y pie de p√°gina */
        height: calc(100vh - 140px); 
        padding-bottom: 0; 
        font-family: 'Segoe UI', sans-serif; 
        margin-left: 0; 
    }
    
    /* IZQUIERDA: CAT√ÅLOGO */
    .catalog-panel { 
        flex: 1.6; 
        background: #f8f9fa; 
        border-radius: 12px; 
        display: flex; 
        flex-direction: column; 
        overflow: hidden; 
        border: 1px solid #e0e0e0; 
        height: 100%; /* Ocupa todo el alto disponible */
    }
    
    /* WIDGET CAJA */
    .caja-dashboard { display: flex; gap: 10px; padding: 10px 15px; background: white; border-bottom: 1px solid #eee; justify-content: space-between; align-items: center; flex-shrink: 0; }
    .caja-item { display: flex; flex-direction: column; align-items: center; flex: 1; border-right: 1px solid #eee; }
    .caja-item:last-child { border-right: none; }
    .caja-item label { font-size: 0.65rem; color: #64748b; font-weight: 700; text-transform: uppercase; margin-bottom: 2px; }
    .input-base { border: 2px solid #e2e8f0; background: #fff; border-radius: 8px; padding: 4px; font-weight: 700; color: #3b82f6; width: 90px; text-align: center; font-size: 1.1rem; }

    /* BOTON CERRAR CAJA */
    .form-cerrar { margin: 0; }
    .btn-cerrar { background: #ef4444; color: white; border: none; padding: 8px 12px; border-radius: 8px; font-weight: 700; cursor: pointer; display: flex; align-items: center; gap: 5px; font-size: 0.75rem; }
    .btn-cerrar:hover { background: #dc2626; }

    /* BUSCADOR */
    .search-area { padding: 10px 15px; background: white; border-bottom: 1px solid #eee; flex-shrink: 0; }
    #buscador { width: 100%; padding: 10px 20px; border-radius: 50px; border: 1px solid #ddd; outline: none; background: #fcfcfc; }

    /* GRID PRODUCTOS (EXPANDIDO) */
    .grid-container { 
        padding: 15px; 
        overflow-y: auto; 
        display: grid; 
        grid-template-columns: repeat(auto-fill, minmax(150px, 1fr)); 
        gap: 15px; 
        flex: 1; /* CLAVE: Empuja hasta abajo ocupando todo el espacio */
        align-content: start; 
        background: #f1f5f9; 
    }
    
    /* TARJETAS */
    .prod-card { background: white; border-radius: 12px; padding: 10px; display: flex; flex-direction: column; justify-content: space-between; height: 100%; border: 1px solid #eee; transition: 0.2s; cursor: pointer; position: relative; box-shadow: 0 2px 5px rgba(0,0,0,0.02); }
    .prod-card:hover { transform: translateY(-3px); box-shadow: 0 8px 20px rgba(0,0,0,0.06); border-color: var(--brand-purple); }
    .prod-img { width: 100%; height: 100px; object-fit: contain; margin-bottom: 8px; mix-blend-mode: multiply; }
    .prod-title { font-weight: 600; font-size: 0.85rem; margin-bottom: 4px; height: 34px; overflow: hidden; color: #333; line-height: 1.2; }
    .prod-price { font-weight: 800; font-size: 1.1rem; color: #4a148c; }
    .stock-badge { position: absolute; top: 8px; right: 8px; background: rgba(0,0,0,0.05); color: #666; font-size: 0.65rem; padding: 2px 6px; border-radius: 4px; font-weight: bold; }

    /* BOTONES ACCION */
    .btn-action { width: 100%; padding: 8px; border-radius: 8px; border: none; font-weight: 700; cursor: pointer; margin-top: auto; display: flex; align-items: center; justify-content: center; gap: 5px; text-transform: uppercase; font-size: 0.7rem; }
    .btn-add { background: #f1f5f9; color: #475569; }
    .btn-add:hover { background: #e2e8f0; color: #1e293b; }
    .btn-options { background: #3b82f6; color: white; }

    /* MENSAJES (SOLO LOS NUESTROS) */
    .alert-container { margin-bottom: 10px; flex-shrink: 0; }
    .alert-box { padding: 12px; border-radius: 8px; font-weight: bold; animation: fadeIn 0.5s; font-size: 0.9rem; display: flex; align-items: center; gap: 10px; margin-bottom: 5px; }
    .alert-error { background: #fee2e2; color: #b91c1c; border: 1px solid #fca5a5; }
    .alert-success { background: #dcfce7; color: #15803d; border: 1px solid #86efac; }
    .alert-info { background: #e0f2fe; color: #0369a1; border: 1px solid #7dd3fc; }

    /* DERECHA: TICKET */
    .ticket-panel { flex: 0.9; background: var(--bg-dark); border-radius: 16px; display: flex; flex-direction: column; color: white; box-shadow: 0 10px 30px rgba(0,0,0,0.2); overflow: hidden; height: 100%; }
    .ticket-header { padding: 15px 20px; border-bottom: 1px solid rgba(255,255,255,0.1); background: rgba(0,0,0,0.2); display: flex; justify-content: space-between; align-items: center; flex-shrink: 0; }
    .cart-items { flex: 1; overflow-y: auto; padding: 15px; }
    .cart-item { background: #2b2d42; padding: 10px; margin-bottom: 8px; border-radius: 8px; display: flex; justify-content: space-between; align-items: center; border-left: 3px solid var(--action-teal); }
    .btn-trash { background: none; border: none; color: #ff5252; cursor: pointer; }
    
    .payment-section { background: #232536; padding: 20px; box-shadow: 0 -5px 20px rgba(0,0,0,0.1); flex-shrink: 0; }
    .calc-row { display: flex; justify-content: space-between; align-items: center; margin-bottom: 10px; }
    .calc-input { background: #151621; border: 1px solid #444; color: white; padding: 8px; border-radius: 8px; width: 110px; text-align: right; font-size: 1.2rem; font-weight: bold; outline: none; }
    
    .btn-checkout { background: linear-gradient(135deg, #00daf2, #6830e0); width: 100%; padding: 14px; border: none; border-radius: 10px; font-weight: 800; font-size: 1.1rem; cursor: pointer; color: white; text-transform: uppercase; margin-top: 10px; }
    .btn-checkout:disabled { background: #333; cursor: not-allowed; opacity: 0.5; }

    /* Modal */
    .modal-overlay { display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.7); z-index: 9999; justify-content: center; align-items: center; }
    .modal-content { background: white; width: 90%; max-width: 420px; border-radius: 16px; overflow: hidden; padding-bottom: 20px; }
    .modal-header { padding: 15px 20px; background: #f8fafc; border-bottom: 1px solid #e2e8f0; display: flex; justify-content: space-between; align-items: center; }
    .var-option { width: 100%; padding: 12px 20px; border: none; border-bottom: 1px solid #f1f5f9; background: white; display: flex; justify-content: space-between; align-items: center; cursor: pointer; transition: 0.2s; text-align: left; }
    .var-option:hover { background: #f0f9ff; }
</style>

<div class="container-fluid">
    
    {% if messages %}
        <div class="alert-container">
        {% for message in messages %}
            <div class="alert-box {% if message.tags == 'error' %}alert-error{% elif message.tags == 'info' %}alert-info{% else %}alert-success{% endif %}">
                <span>{{ message }}</span>
            </div>
        {% endfor %}
        </div>
    {% endif %}

    <div class="pos-wrapper">
        <div class="catalog-panel">
            <div class="caja-dashboard">
                <div class="caja-item">
                    <label>üíµ Base Inicial</label>
                    <input type="number" id="baseCaja" class="input-base" value="0.00" oninput="calcularCaja()">
                </div>
                <div class="caja-item">
                    <label>üìà Ventas Hoy</label>
                    <strong style="font-size:1.3rem;">$<span id="ventasHoy">{{ ventas_hoy|floatformat:2|default:"0.00" }}</span></strong>
                </div>
                <div class="caja-item">
                    <label>üí∞ Total Caja</label>
                    <span style="color:#22c55e; font-size:1.5rem; font-weight:800;">$<span id="totalCaja">0.00</span></span>
                </div>
                
                <form method="POST" class="form-cerrar" onsubmit="return confirm('¬øCerrar caja y reiniciar vista?')">
                    {% csrf_token %}
                    <input type="hidden" name="accion" value="cerrar_caja">
                    <button class="btn-cerrar"><i class="fas fa-power-off"></i> CERRAR</button>
                </form>
            </div>

            <div class="search-area">
                <input type="text" id="buscador" placeholder="üîç Buscar producto..." onkeyup="filtrar()">
            </div>
            
            <div class="grid-container">
                {% for p in productos %}
                    {% if p.variaciones.exists or p.variacion_set.exists %}
                        <div class="prod-card item-card" data-name="{{ p.nombre|lower }}" onclick="abrirModal('{{ p.id }}')">
                            <span class="stock-badge">Var.</span>
                            <div>
                                {% if p.imagen %}<img src="{{ p.imagen.url }}" class="prod-img">{% endif %}
                                <div class="prod-title">{{ p.nombre }}</div>
                                <div class="prod-price">${{ p.precio }}</div>
                            </div>
                            <button class="btn-action btn-options"><i class="fas fa-layer-group"></i> Opciones</button>
                            
                            <div id="modal-{{ p.id }}" style="display:none;">
                                <div class="modal-header">
                                    <h4 style="margin:0;">{{ p.nombre }}</h4>
                                    <button onclick="cerrarModal()" style="border:none; font-size:1.5rem;">&times;</button>
                                </div>
                                <div style="max-height:350px; overflow-y:auto;">
                                    <p style="padding:10px 20px; color:#666; background:#f8fafc; font-size:0.8rem;">Selecciona variante:</p>
                                    {% for v in p.variacion_set.all %}
                                        {% if v.stock > 0 %}
                                        <form method="POST">
                                            {% csrf_token %}
                                            <input type="hidden" name="accion" value="agregar">
                                            <input type="hidden" name="producto_id" value="{{ p.id }}">
                                            <input type="hidden" name="variacion_id" value="{{ v.id }}">
                                            <button class="var-option">
                                                <span style="font-weight:700;">{{ v.nombre }}</span>
                                                <span style="background:#dcfce7; padding:2px 8px; border-radius:10px; font-size:0.75rem;">Stock: {{ v.stock }}</span>
                                            </button>
                                        </form>
                                        {% else %}
                                            <div class="var-option" style="opacity:0.5; cursor:not-allowed;"><span>{{ v.nombre }}</span><span style="background:#fee2e2; padding:2px 8px;">Agotado</span></div>
                                        {% endif %}
                                    {% endfor %}
                                    {% for v in p.variaciones.all %}
                                        {% if v.stock > 0 %}
                                        <form method="POST">
                                            {% csrf_token %}
                                            <input type="hidden" name="accion" value="agregar">
                                            <input type="hidden" name="producto_id" value="{{ p.id }}">
                                            <input type="hidden" name="variacion_id" value="{{ v.id }}">
                                            <button class="var-option">
                                                <span style="font-weight:700;">{{ v.nombre }}</span>
                                                <span style="background:#dcfce7; padding:2px 8px; border-radius:10px; font-size:0.75rem;">Stock: {{ v.stock }}</span>
                                            </button>
                                        </form>
                                        {% endif %}
                                    {% endfor %}
                                </div>
                            </div>
                        </div>
                    {% else %}
                        <form method="POST" class="item-card" data-name="{{ p.nombre|lower }}" style="height:100%;">
                            {% csrf_token %}
                            <input type="hidden" name="accion" value="agregar">
                            <input type="hidden" name="producto_id" value="{{ p.id }}">
                            <div class="prod-card" onclick="this.parentNode.submit()">
                                <span class="stock-badge">Stock: {{ p.stock }}</span>
                                <div>
                                    {% if p.imagen %}<img src="{{ p.imagen.url }}" class="prod-img">{% endif %}
                                    <div class="prod-title">{{ p.nombre }}</div>
                                    <div class="prod-price">${{ p.precio }}</div>
                                </div>
                                {% if p.stock > 0 %}
                                    <div class="btn-action btn-add"><i class="fas fa-plus"></i> Agregar</div>
                                {% else %}
                                    <div class="btn-action" style="background:#fee2e2; color:#ef4444; cursor:not-allowed;">AGOTADO</div>
                                {% endif %}
                            </div>
                        </form>
                    {% endif %}
                {% endfor %}
            </div>
        </div>

        <div class="ticket-panel">
            <div class="ticket-header">
                <span style="font-weight:700; letter-spacing:1px;">TICKET</span>
                <span style="background:rgba(255,255,255,0.15); padding:2px 8px; border-radius:4px; font-size:0.8rem;">{{ carrito_pos|length }} Items</span>
            </div>
            <div class="cart-items">
                {% for key, item in carrito_pos.items %}
                <div class="cart-item">
                    <div style="flex:1;">
                        <div style="font-weight:600; font-size:0.9rem;">{{ item.nombre }}</div>
                        <div style="font-size:0.8rem; color:#aaa;">{{ item.cantidad }} x ${{ item.precio }}</div>
                    </div>
                    <div style="display:flex; align-items:center; gap:12px;">
                        <div style="font-weight:bold;">${{ item.subtotal|floatformat:2 }}</div>
                        <form method="POST" style="margin:0;">
                            {% csrf_token %}
                            <input type="hidden" name="accion" value="eliminar">
                            <input type="hidden" name="item_key" value="{{ key }}">
                            <button class="btn-trash"><i class="fas fa-trash"></i></button>
                        </form>
                    </div>
                </div>
                {% empty %}
                <div style="text-align:center; padding:50px 20px; color:#666;">
                    <i class="fas fa-shopping-cart fa-3x" style="opacity:0.2; margin-bottom:15px;"></i>
                    <p>Carrito vac√≠o</p>
                </div>
                {% endfor %}
            </div>

            <div class="payment-section">
                <div class="calc-row">
                    <span style="color:#aaa; font-size:0.85rem; font-weight:700;">TOTAL A PAGAR</span>
                    <span style="font-size:1.5rem; font-weight:800; color:white;">$<span id="montoTotal" data-val="{{ total_pos }}">{{ total_pos|floatformat:2 }}</span></span>
                </div>
                <div class="calc-row">
                    <span style="color:#aaa; font-size:0.85rem; font-weight:700;">EFECTIVO</span>
                    <input type="number" id="pagoCliente" class="calc-input" placeholder="0.00" oninput="calcularVuelto()" step="0.01">
                </div>
                <div class="calc-row" style="margin-top:15px; border-top:1px dashed #444; padding-top:15px;">
                    <span style="color:var(--action-teal); font-weight:700;">CAMBIO</span>
                    <span style="font-size:1.6rem; font-weight:800; color:var(--action-teal);">$<span id="vueltoCliente">0.00</span></span>
                </div>
                <div id="avisoCaja" style="display:none; color:#fbbf24; font-size:0.8rem; margin-top:5px; text-align:right;">
                    ‚ö†Ô∏è Caja Insuficiente
                </div>

                <form method="POST" style="margin-top:10px;">
                    {% csrf_token %}
                    <input type="hidden" name="accion" value="cobrar">
                    <button class="btn-checkout" id="btnCobrar" {% if not carrito_pos %}disabled{% endif %}>
                        COBRAR <i class="fas fa-check"></i>
                    </button>
                </form>
            </div>
        </div>
    </div>
</div>

<div id="modalGlobal" class="modal-overlay" onclick="if(event.target == this) cerrarModal()">
    <div class="modal-content" id="modalCuerpo"></div>
</div>

<script>
    function abrirModal(id) {
        let contenido = document.getElementById('modal-' + id).innerHTML;
        document.getElementById('modalCuerpo').innerHTML = contenido;
        document.getElementById('modalGlobal').style.display = 'flex';
    }
    function cerrarModal() { document.getElementById('modalGlobal').style.display = 'none'; }
    
    function filtrar() {
        let texto = document.getElementById('buscador').value.toLowerCase();
        document.querySelectorAll('.item-card').forEach(el => {
            if(el.dataset.name.includes(texto)) el.style.display = "flex";
            else el.style.display = "none";
        });
    }

    document.addEventListener("DOMContentLoaded", function() {
        let cajaCerrada = "{{ caja_cerrada }}" === "True";
        if (cajaCerrada) {
            localStorage.setItem('pos_base', 0);
            document.getElementById('baseCaja').value = 0;
        } else {
            let base = localStorage.getItem('pos_base') || 0;
            document.getElementById('baseCaja').value = base;
        }
        calcularCaja();
    });

    function calcularCaja() {
        let base = parseFloat(document.getElementById('baseCaja').value) || 0;
        let ventas = parseFloat(document.getElementById('ventasHoy').innerText.replace(',', '.')) || 0;
        let total = base + ventas;
        document.getElementById('totalCaja').innerText = total.toFixed(2);
        localStorage.setItem('pos_base', base);
        
        // Recalcular vuelto por si cambi√≥ la base
        calcularVuelto();
    }

    function calcularVuelto() {
        let total = parseFloat(document.getElementById('montoTotal').dataset.val.replace(',', '.')) || 0;
        let pago = parseFloat(document.getElementById('pagoCliente').value) || 0;
        let vuelto = pago - total;
        
        let display = document.getElementById('vueltoCliente');
        let aviso = document.getElementById('avisoCaja');
        let totalEnCaja = parseFloat(document.getElementById('totalCaja').innerText);

        if (pago >= total) {
            display.innerText = vuelto.toFixed(2);
            display.style.color = "#00f2c3"; // Verde
            
            // 3. VALIDACI√ìN DE CAJA (Nueva L√≥gica)
            // Si el vuelto a dar es MAYOR a lo que hay en la caja (Base + Ventas anteriores)
            // Nota: T√©cnicamente el pago del cliente entra a la caja, pero para dar vuelto 
            // necesitas billetes peque√±os. Esta es una alerta √∫til.
            if (vuelto > totalEnCaja) {
                aviso.style.display = 'block';
                aviso.innerText = "‚ö†Ô∏è Advertencia: Posible falta de cambio en caja";
            } else {
                aviso.style.display = 'none';
            }

            {% if carrito_pos %} 
                document.getElementById('btnCobrar').disabled = false;
                document.getElementById('btnCobrar').style.opacity = "1";
            {% endif %}
        } else {
            if (pago > 0) {
                display.innerText = "Falta " + Math.abs(vuelto).toFixed(2);
                display.style.color = "#ff5252"; // Rojo
                aviso.style.display = 'none';
            } else {
                display.innerText = "0.00";
                aviso.style.display = 'none';
            }
        }
    }
</script>
{% endblock %}